@{
    ViewData["Title"] = "İletişim";
    var messages = ViewBag.Messages as List<JurisFlowASP.Models.ClientMessage> ?? new();
    var notifications = ViewBag.Notifications as List<JurisFlowASP.Models.Notification> ?? new();
    var clients = ViewBag.Clients as List<JurisFlowASP.Models.Client> ?? new();
    var matters = ViewBag.Matters as List<JurisFlowASP.Models.Matter> ?? new();
    var currentTab = ViewBag.CurrentTab?.ToString() ?? "inbox";
    var unreadCount = ViewBag.UnreadCount ?? 0;
}

<!-- Tabs -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link @(currentTab == "inbox" ? "active" : "")" href="?tab=inbox">
            <i class="bi bi-inbox me-1"></i> Gelen Kutusu
            @if (unreadCount > 0)
            {
                <span class="badge bg-danger ms-1">@unreadCount</span>
            }
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(currentTab == "compose" ? "active" : "")" href="?tab=compose">
            <i class="bi bi-pencil-square me-1"></i> Yeni E-posta
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(currentTab == "notifications" ? "active" : "")" href="?tab=notifications">
            <i class="bi bi-bell me-1"></i> Bildirimler
        </a>
    </li>
</ul>

@if (currentTab == "inbox")
{
    <!-- Inbox -->
    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-inbox me-2"></i>Müvekkil Mesajları</h5>
            <span class="badge bg-primary">@messages.Count mesaj</span>
        </div>
        <div class="card-body p-0">
            @if (!messages.Any())
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="text-muted mt-2">Henüz mesaj yok</p>
                </div>
            }
            else
            {
                <div class="list-group list-group-flush">
                    @foreach (var msg in messages)
                    {
                        var bgClass = msg.Read ? "" : "bg-light";
                        <div class="list-group-item @bgClass" id="msg-@msg.Id">
                            <div class="d-flex align-items-start">
                                <div class="avatar-circle bg-primary text-white me-3" style="width: 40px; height: 40px; font-size: 0.9rem;">
                                    @(msg.Client?.Name.Substring(0, 1).ToUpper() ?? "?")
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>@(msg.Client?.Name ?? "Bilinmeyen")</strong>
                                            @if (!msg.Read)
                                            {
                                                <span class="badge bg-primary ms-2">Yeni</span>
                                            }
                                        </div>
                                        <small class="text-muted">@msg.CreatedAt.ToString("dd MMM HH:mm")</small>
                                    </div>
                                    <h6 class="mb-1">@msg.Subject</h6>
                                    <p class="text-muted mb-2">@msg.Message</p>
                                    @if (msg.Matter != null)
                                    {
                                        <small class="text-muted"><i class="bi bi-folder me-1"></i>@msg.Matter.Name</small>
                                    }
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#replyModal-@msg.Id">
                                            <i class="bi bi-reply me-1"></i> Yanıtla
                                        </button>
                                        <form asp-action="DeleteMessage" asp-route-id="@msg.Id" method="post" class="d-inline"
                                              onsubmit="return confirm('Bu mesajı silmek istediğinize emin misiniz?');">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reply Modal -->
                        <div class="modal fade" id="replyModal-@msg.Id" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Yanıtla: @msg.Subject</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form asp-action="Reply" method="post">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="messageId" value="@msg.Id" />
                                        <div class="modal-body">
                                            <div class="alert alert-light">
                                                <small><strong>Alıcı:</strong> @msg.Client?.Email</small>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Yanıt</label>
                                                <textarea name="replyText" class="form-control" rows="5" required></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-send me-1"></i> Gönder
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}
else if (currentTab == "compose")
{
    <!-- Compose Email -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Yeni E-posta</h5>
                </div>
                <div class="card-body">
                    <form asp-action="SendEmail" method="post">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label class="form-label">Alıcı E-posta *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                <input type="email" name="toEmail" class="form-control" required placeholder="ornek@email.com" list="clientEmails" />
                            </div>
                            <datalist id="clientEmails">
                                @foreach (var client in clients)
                                {
                                    <option value="@client.Email">@client.Name</option>
                                }
                            </datalist>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Konu *</label>
                            <input type="text" name="subject" class="form-control" required placeholder="E-posta konusu" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">İlgili Dava</label>
                            <select name="matterId" class="form-select">
                                <option value="">Seçiniz (Opsiyonel)</option>
                                @foreach (var matter in matters)
                                {
                                    <option value="@matter.Id">@matter.CaseNumber - @matter.Name</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">İçerik *</label>
                            <textarea name="body" class="form-control" rows="8" required placeholder="E-posta içeriğini yazın..."></textarea>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a href="?tab=inbox" class="btn btn-outline-secondary">İptal</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send me-1"></i> Gönder
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}
else if (currentTab == "notifications")
{
    <!-- Notifications -->
    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-bell me-2"></i>Bildirimler</h5>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newNotificationModal">
                <i class="bi bi-plus-lg me-1"></i> Bildirim Oluştur
            </button>
        </div>
        <div class="card-body p-0">
            @if (!notifications.Any())
            {
                <div class="text-center py-5">
                    <i class="bi bi-bell-slash fs-1 text-muted"></i>
                    <p class="text-muted mt-2">Henüz bildirim yok</p>
                </div>
            }
            else
            {
                <div class="list-group list-group-flush">
                    @foreach (var notif in notifications)
                    {
                        var iconClass = notif.Type switch
                        {
                            "success" => "bi-check-circle-fill text-success",
                            "warning" => "bi-exclamation-triangle-fill text-warning",
                            "error" => "bi-x-circle-fill text-danger",
                            _ => "bi-info-circle-fill text-primary"
                        };
                        var bgClass = notif.Read ? "" : "bg-light";
                        <div class="list-group-item @bgClass">
                            <div class="d-flex align-items-start">
                                <i class="bi @iconClass me-3 mt-1"></i>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">@notif.Title</h6>
                                        <small class="text-muted">@notif.CreatedAt.ToString("dd MMM HH:mm")</small>
                                    </div>
                                    <p class="mb-0 text-muted">@notif.Message</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- New Notification Modal -->
    <div class="modal fade" id="newNotificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yeni Bildirim Oluştur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form asp-action="CreateNotification" method="post">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Başlık *</label>
                            <input type="text" name="title" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mesaj *</label>
                            <textarea name="message" class="form-control" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tür</label>
                            <select name="type" class="form-select">
                                <option value="info">Bilgi</option>
                                <option value="success">Başarı</option>
                                <option value="warning">Uyarı</option>
                                <option value="error">Hata</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Link (Opsiyonel)</label>
                            <input type="url" name="link" class="form-control" placeholder="/Matters/Details/..." />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Oluştur</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}
