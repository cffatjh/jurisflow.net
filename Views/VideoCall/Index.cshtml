@{
    ViewData["Title"] = "Video Görüşme";
    var clients = ViewBag.Clients as List<JurisFlowASP.Models.Client> ?? new();
    var matters = ViewBag.Matters as List<JurisFlowASP.Models.Matter> ?? new();
    bool zoomConfigured = ViewBag.ZoomConfigured ?? false;
    bool googleConfigured = ViewBag.GoogleConfigured ?? false;
}

<div class="row g-4">
    <!-- Provider Selection -->
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Bağlantılar</h5>
            </div>
            <div class="card-body">
                <!-- Zoom -->
                <div class="d-flex align-items-center justify-content-between p-3 border rounded mb-3">
                    <div class="d-flex align-items-center">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/Zoom_Communications_Logo.svg/1200px-Zoom_Communications_Logo.svg.png" 
                             alt="Zoom" style="width: 80px; height: auto;" class="me-3">
                        <div>
                            <h6 class="mb-0">Zoom</h6>
                            <small class="text-muted">Video konferans</small>
                        </div>
                    </div>
                    @if (zoomConfigured)
                    {
                        <span class="badge bg-success"><i class="bi bi-check"></i> Bağlı</span>
                    }
                    else
                    {
                        <a asp-action="ZoomAuth" class="btn btn-sm btn-outline-primary">Bağlan</a>
                    }
                </div>

                <!-- Google Meet -->
                <div class="d-flex align-items-center justify-content-between p-3 border rounded">
                    <div class="d-flex align-items-center">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9b/Google_Meet_icon_%282020%29.svg/1200px-Google_Meet_icon_%282020%29.svg.png" 
                             alt="Google Meet" style="width: 40px; height: auto;" class="me-3">
                        <div>
                            <h6 class="mb-0">Google Meet</h6>
                            <small class="text-muted">Google video görüşme</small>
                        </div>
                    </div>
                    @if (googleConfigured)
                    {
                        <span class="badge bg-success"><i class="bi bi-check"></i> Bağlı</span>
                    }
                    else
                    {
                        <a asp-action="GoogleAuth" class="btn btn-sm btn-outline-primary">Bağlan</a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Create Meeting -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-camera-video me-2"></i>Yeni Toplantı Oluştur</h5>
            </div>
            <div class="card-body">
                <form id="meetingForm">
                    @Html.AntiForgeryToken()

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Platform *</label>
                            <select id="provider" class="form-select" required>
                                <option value="">Seçiniz</option>
                                <option value="zoom">Zoom</option>
                                <option value="google">Google Meet</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Toplantı Konusu *</label>
                            <input type="text" id="topic" class="form-control" required placeholder="Örn: Müvekkil Görüşmesi" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Başlangıç Tarihi/Saati *</label>
                            <input type="datetime-local" id="startTime" class="form-control" required />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Süre (dakika) *</label>
                            <select id="duration" class="form-select" required>
                                <option value="30">30 dakika</option>
                                <option value="45">45 dakika</option>
                                <option value="60" selected>1 saat</option>
                                <option value="90">1.5 saat</option>
                                <option value="120">2 saat</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">İlgili Dava</label>
                            <select id="matterId" class="form-select">
                                <option value="">Seçiniz (Opsiyonel)</option>
                                @foreach (var matter in matters)
                                {
                                    <option value="@matter.Id">@matter.CaseNumber - @matter.Name</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Katılımcı E-posta</label>
                            <input type="email" id="attendeeEmail" class="form-control" placeholder="ornek@email.com" list="clientEmails" />
                            <datalist id="clientEmails">
                                @foreach (var client in clients)
                                {
                                    <option value="@client.Email">@client.Name</option>
                                }
                            </datalist>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary" id="createBtn">
                                <i class="bi bi-plus-lg me-1"></i> Toplantı Oluştur
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Result -->
        <div id="resultCard" class="card shadow-sm mt-4" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i>Toplantı Oluşturuldu!</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success mb-3">
                    <i class="bi bi-link-45deg me-2"></i>
                    <a id="meetingLink" href="#" target="_blank" class="fw-bold"></a>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="copyLink()">
                        <i class="bi bi-clipboard me-1"></i> Linki Kopyala
                    </button>
                    <a id="joinBtn" href="#" target="_blank" class="btn btn-success">
                        <i class="bi bi-camera-video me-1"></i> Toplantıya Katıl
                    </a>
                </div>
            </div>
        </div>

        <!-- Error -->
        <div id="errorCard" class="alert alert-danger mt-4" style="display: none;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="errorMessage"></span>
        </div>
    </div>
</div>

@section Scripts {
<script>
// Set default datetime to now + 1 hour
const now = new Date();
now.setHours(now.getHours() + 1);
now.setMinutes(0);
document.getElementById('startTime').value = now.toISOString().slice(0, 16);

let meetingUrl = '';

document.getElementById('meetingForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const provider = document.getElementById('provider').value;
    const topic = document.getElementById('topic').value;
    const startTime = document.getElementById('startTime').value;
    const duration = document.getElementById('duration').value;
    const matterId = document.getElementById('matterId').value;
    const attendeeEmail = document.getElementById('attendeeEmail').value;
    
    const btn = document.getElementById('createBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Oluşturuluyor...';
    
    document.getElementById('resultCard').style.display = 'none';
    document.getElementById('errorCard').style.display = 'none';
    
    const formData = new FormData();
    formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
    
    let endpoint = '';
    if (provider === 'zoom') {
        endpoint = '/VideoCall/CreateZoomMeeting';
        formData.append('topic', topic);
        formData.append('startTime', startTime);
        formData.append('duration', duration);
        formData.append('matterId', matterId);
        formData.append('clientEmail', attendeeEmail);
    } else {
        endpoint = '/VideoCall/CreateGoogleMeet';
        formData.append('summary', topic);
        formData.append('startTime', startTime);
        formData.append('duration', duration);
        formData.append('matterId', matterId);
        formData.append('attendeeEmail', attendeeEmail);
    }
    
    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            meetingUrl = result.meetingUrl;
            document.getElementById('meetingLink').href = meetingUrl;
            document.getElementById('meetingLink').textContent = meetingUrl;
            document.getElementById('joinBtn').href = meetingUrl;
            document.getElementById('resultCard').style.display = 'block';
        } else {
            document.getElementById('errorMessage').textContent = result.error;
            document.getElementById('errorCard').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('errorMessage').textContent = 'Bir hata oluştu: ' + error.message;
        document.getElementById('errorCard').style.display = 'block';
    }
    
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-plus-lg me-1"></i> Toplantı Oluştur';
});

function copyLink() {
    navigator.clipboard.writeText(meetingUrl);
    alert('Link panoya kopyalandı!');
}
</script>
}
